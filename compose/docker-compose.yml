services:

  minio:
    image: minio/minio:${MINIO_VERSION:-latest}
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-changeme123}
    volumes:
      - minio-data:/data
    ports:
      - "${MINIO_API_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - analytics-net

  minio-init:
    image: minio/mc:latest
    container_name: minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
        mc alias set local http://minio:9000 ${MINIO_ROOT_USER:-minioadmin} ${MINIO_ROOT_PASSWORD:-changeme123};
        mc mb --ignore-existing local/${MINIO_DEFAULT_BUCKET:-iceberg-warehouse};
        mc anonymous set public local/${MINIO_DEFAULT_BUCKET:-iceberg-warehouse};
        echo 'MinIO bucket ready.';
        exit 0;
      "
    networks:
      - analytics-net

  postgres:
    image: postgres:${POSTGRES_VERSION:-16-alpine}
    container_name: postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-iceberg}
      POSTGRES_USER: ${POSTGRES_USER:-iceberg}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - pg-data:/var/lib/postgresql/data
      - ./init-scripts/postgres:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-iceberg} -d ${POSTGRES_DB:-iceberg}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - analytics-net

  iceberg-rest:
    image: tabulario/iceberg-rest:${ICEBERG_REST_VERSION:-0.10.0}
    container_name: iceberg-rest
    depends_on:
      postgres:
        condition: service_healthy
      minio-init:
        condition: service_completed_successfully
    environment:
      # JDBC backend â€” persists catalog state in Postgres
      CATALOG_CATALOG__IMPL: org.apache.iceberg.jdbc.JdbcCatalog
      CATALOG_URI: jdbc:postgresql://postgres:5432/${POSTGRES_DB:-iceberg}
      CATALOG_JDBC_USER: ${POSTGRES_USER:-iceberg}
      CATALOG_JDBC_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      # Warehouse root on MinIO
      CATALOG_WAREHOUSE: s3://${MINIO_DEFAULT_BUCKET:-iceberg-warehouse}/
      # S3 / MinIO credentials
      CATALOG_IO__IMPL: org.apache.iceberg.aws.s3.S3FileIO
      CATALOG_S3_ENDPOINT: http://minio:9000
      CATALOG_S3_PATH__STYLE__ACCESS: "true"
      AWS_ACCESS_KEY_ID: ${MINIO_ROOT_USER:-minioadmin}
      AWS_SECRET_ACCESS_KEY: ${MINIO_ROOT_PASSWORD:-changeme123}
      AWS_REGION: ${AWS_REGION:-us-east-1}
    ports:
      - "${ICEBERG_REST_PORT:-8181}:8181"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/v1/config"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s
    networks:
      - analytics-net

  trino:
    image: trinodb/trino:${TRINO_VERSION:-435}
    container_name: trino
    depends_on:
      iceberg-rest:
        condition: service_healthy
    ports:
      - "${TRINO_PORT:-8080}:8080"
    volumes:
      - ./conf/trino/etc:/etc/trino:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/v1/info"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - analytics-net

networks:
  analytics-net:
    driver: bridge

volumes:
  pg-data:
  minio-data: